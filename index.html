<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
      <title>Open AQ Time Series</title>
      <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
      <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
      <script src="https://code.highcharts.com/highcharts.js"></script>
      <script src="https://code.highcharts.com/modules/exporting.js"></script>
      <script src="https://code.highcharts.com/modules/export-data.js"></script>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-12 py-4">
          <h1 style="font-size: 3em; font-weight: 600">OpenAQ Time Series</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-8">
          <div id="ts-chart" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
        </div>
        <div class="col-4">
          <form>
            <div class="form-group">
              <label for="citySelect">Select a city</label>
              <select class="form-control" id="citySelect">
                <option selected="selected">Shanghai</option>
              </select>
            </div>
    
            <div class="form-group">
              <label for="locationSelect">Select a location</label>
              <select class="form-control" id="locationSelect">
                <option selected="selected">somewhere over the rainbow</option>
              </select>
            </div> 
    
            <div class="form-group">
              <label for="parameterSelect" >Select a parameter</label>
              <select class="form-control" id="parameterSelect">
                <option selected="selected">pm25</option>
              </select>
            </div>        
          </form>
        </div>
      </div>
    </div>
    
    <script type="text/javascript">
      const dropdowns = {
        'cities': document.getElementById('citySelect'),
        'locations': document.getElementById('locationSelect'),
        'params': document.getElementById('parameterSelect'),
      }
      let state = {
        cities: [],
        locations: [],
        params: [],
        currentCity: 'Delhi',
        currentLocation: 'Anand Vihar',
        currentParam: 'pm25',
      }

      const updateState = newState => {
        state = Object.assign({}, state, newState);
        updateDropdownsOptions(state);
        updateDropdownsSelected(state);
      }

      const updateDropdownsOptions = state => {
        Object.keys(dropdowns).forEach(key => {
          const select = dropdowns[key];
          select.options.length = 0;
      
          /* Insert the new ones from the array above */
          state[key].forEach(value => {
            select.options[select.options.length] = new Option(value, value);
          })
        })
      }

      const updateDropdownsSelected = state => {
        dropdowns['cities'].value = state.currentCity;
        dropdowns['locations'].value = state.currentLocation;
        dropdowns['params'].value = state.currentParam;        
      }
    
      const updateChart = () => {
        const {
          currentCity: city,
          currentLocation: location,
          currentParam: parameter,
        } = state

        let dataLocation = `https://s3.amazonaws.com/aimeeb-datasets-public/openaq/timeseries/${city}/${location.split(' ').join('+')}/${parameter}/all-highcharts.json`;
        axios.get(dataLocation)
          .then(({ data }) => {
            Highcharts.chart('ts-chart', {
              chart: {
                type: 'scatter',
                  zoomType: 'x'
              },
              title: {
                  text: `${city} ${parameter} Levels`
              },
              subtitle: {
                  text: document.ontouchstart === undefined ? 'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in',
              },
              xAxis: {
                  type: 'datetime',
              },
              yAxis: {
                  title: {
                      text: parameter
                  }
              },
              legend: {
                  enabled: false
              },
              plotOptions: {
                scatter: {
                    marker: {
                        radius: 2,
                        states: {
                            hover: {
                                enabled: true,
                                lineColor: 'rgb(100,100,100)'
                            }
                        }
                    },
                    states: {
                        hover: {
                            marker: {
                                enabled: false
                            }
                        }
                    },
                    tooltip: {
                        pointFormatter: function() {
                          const dateObject = new Date(this.x).toLocaleString();
                          return '<b>' + dateObject + '</b>: ' + this.y;
                        }
                    }
                }
              },
              series: [{
                  name: parameter,
                  data: data
              }]
            });
          })
      }
    
      const updateParameters = location => {
        axios.get(`https://api.openaq.org/v1/locations?location[]=${ location }`)
          .then(res => {
            const params = res.data.results[0].parameters;
            const currentParam = params[0];
            updateState({ currentParam, params })
            updateChart();     
          })
      }
    
      const updateLocations = city => {
        axios.get(`https://api.openaq.org/v1/locations?city[]=${ city }`)
          .then(res => {
            const locations = res.data.results.map(location => location['location']);
            const currentLocation = locations[0];
            updateState({ currentLocation, locations });
            updateParameters(currentLocation);
          })
      }

      dropdowns['cities'].addEventListener('change', () => {
        const currentCity = document.querySelector("#citySelect option:checked").innerText;
        updateState({ currentCity })
        updateLocations(currentCity);
      })
      
      dropdowns['locations'].addEventListener('change', () => {
        const currentLocation = document.querySelector("#locationSelect option:checked").innerText;
        updateState({ currentLocation })
        updateParameters(currentLocation);
      });
      
      dropdowns['params'].addEventListener('change', () => {
        const currentParam = document.querySelector("#parameterSelect option:checked").innerText;
        updateState({ currentParam })
        updateChart();
      });
    
      // ########## INITIALIZE ############
      axios.get('https://api.openaq.org/v1/cities?order_by=count&sort=desc&limit=200')
        .then(res => {
          const cities = res.data.results.map(city => city['city']);
          updateState({ cities });
        })
    
      updateLocations(state.currentCity);  
    </script>
    
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  
  </body>
</html>  
